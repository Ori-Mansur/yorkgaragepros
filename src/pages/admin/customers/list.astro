---
import "../../../styles/global.css";
import AdminLayout from "../../../layouts/AdminLayout.astro";
import CustomerTable from "../../../components/vue/customers/CustomerTable.vue";

import { db } from "../../../db";
import { Customers, Locations, Documents } from "../../../db/schema";
import { eq, desc } from "drizzle-orm";

// 1. Fetch data with a Left Join
// Note: If a customer has 3 locations, "result" will have 3 rows for that customer
const result = await db
  .select()
  .from(Customers)
  .leftJoin(Locations, eq(Customers.id, Locations.customerId));

// 2. Fetch all documents
const allDocs = await db.select().from(Documents).orderBy(desc(Documents.issueDate));

// 3. Group Locations by Customer
const customerMap = new Map();

result.forEach((row) => {
  const customerId = row.customers.id;
  
  if (!customerMap.has(customerId)) {
    customerMap.set(customerId, {
      ...row.customers,
      locations: [], // Initialize as an array for multiple addresses
      documents: allDocs.filter(d => d.customerId === customerId)
    });
  }

  // Add location to the array if it exists
  if (row.locations) {
    customerMap.get(customerId).locations.push(row.locations);
  }
});

const customersWithDocs = Array.from(customerMap.values());
---

<AdminLayout title="Customer Directory">
  <main class="admin-container">
    <div class="list-header">
      <div class="header-text">
        <h1>Customer Directory</h1>
        <p>{customersWithDocs.length} total records found</p>
      </div>
      <a href="/admin/customers/new" class="btn-primary">+ New Customer</a>
    </div>

    <CustomerTable client:load initialCustomers={customersWithDocs} />
  </main>
</AdminLayout>

<style>
  .admin-container {
    padding: 20px; /* Reduced for mobile */
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    gap: 15px;
  }

  .header-text h1 {
    margin: 0;
    font-size: 1.75rem;
    color: #0f172a;
  }

  .header-text p {
    margin: 4px 0 0 0;
    color: #64748b;
    font-size: 0.875rem;
  }

  .btn-primary {
    background: #2563eb;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 700;
    white-space: nowrap;
    transition: background 0.2s;
  }

  .btn-primary:hover {
    background: #1d4ed8;
  }

  /* ðŸ“± Mobile Specific Header */
  @media (max-width: 640px) {
    .admin-container {
      padding: 15px;
    }
    .list-header {
      flex-direction: column;
      align-items: flex-start;
    }
    .btn-primary {
      width: 100%;
      text-align: center;
    }
  }
</style>