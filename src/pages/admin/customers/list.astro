---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import CustomerTable from "../../../components/vue/customers/CustomerTable.vue";
import { db, Customers, Locations, Documents, eq, desc } from "astro:db";

// Fetch joined data
const result = await db
  .select()
  .from(Customers)
  .leftJoin(Locations, eq(Customers.id, Locations.customerId))
  .all();

// Fetch documents
const allDocs = await db.select().from(Documents).orderBy(desc(Documents.issueDate)).all();

// Format data for Vue: Group docs inside the customer object
const customersWithDocs = result.map(({ Customers: c, Locations: l }) => ({
  ...c,
  location: l,
  documents: allDocs.filter(d => d.customerId === c.id)
}));
---

<AdminLayout title="Customer Directory">
  <main class="admin-container">
    <div class="list-header">
      <h1>Customer Directory</h1>
      <a href="/admin/customers" class="btn-primary">+ Add New Customer</a>
    </div>

    <CustomerTable client:load initialCustomers={customersWithDocs} />
  </main>
</AdminLayout>
<style>
  .admin-container {
    padding: 40px;
    max-width: 1200px;
    margin: 0 auto;
  }
  .list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
  }
   .btn-primary {
    background: #2563eb;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
  }
</style>