---
import "../styles/global.css";
import "../styles/booking.css";
import Layout from "../layouts/Layout.astro";
---

<Layout
    title="York Garage Pros | Book Your Free Garage Renovation Estimate"
    description="Schedule a consultation with our renovation specialists."
    hasFirebase={true}
>
    <!-- Booking Form Container -->
    <div class="booking-container">
        <!-- Left Side: Header/Visual -->
        <div class="booking-left">
            <div>
                <h1>Book Your Slot</h1>
                <p>
                    Secure your appointment with us easily. Please fill out the
                    form to confirm your reservation and provide service
                    location details.
                </p>
            </div>
            <div class="booking-left-footer">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="calendar-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"
                    ></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <p>Confirmation sent via email.</p>
            </div>
        </div>

        <!-- Right Side: Form -->
        <div class="booking-right">
            <form id="bookingForm">
                <!-- Service Selection -->
                <div class="form-group">
                    <label for="service"
                        >Select Service <span class="required">*</span></label
                    >
                    <select
                        id="service"
                        name="service"
                        required
                        class="form-input"
                    >
                        <option value="">Choose a service...</option>
                        <option value="NewDoorInstall"
                            >New Garage Door Installation</option
                        >
                        <option value="EmergencyRepair"
                            >Emergency Door Repair</option
                        >
                        <option value="FloorCoating">Epoxy Floor Coating</option
                        >
                    </select>
                </div>

                <!-- Garage Size -->
                <div class="form-group">
                    <label id="garageSizeLabel" for="garageSize"
                        >Garage Size</label
                    >
                    <select
                        id="garageSize"
                        name="garageSize"
                        class="form-input"
                    >
                        <option value="">Select size...</option>
                        <option value="1 Car">1 Car (Single Door)</option>
                        <option value="2 Car">2 Car (Standard Double)</option>
                        <option value="3+ Car">3+ Car / Custom</option>
                    </select>
                </div>

                <!-- Date & Time -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="date"
                            >Date <span class="required">*</span></label
                        >
                        <input
                            type="date"
                            id="date"
                            name="date"
                            required
                            class="form-input"
                        />
                    </div>
                    <div class="form-group">
                        <label for="time"
                            >Time <span class="required">*</span></label
                        >
                        <input
                            type="time"
                            id="time"
                            name="time"
                            required
                            class="form-input"
                        />
                    </div>
                </div>

                <!-- Name & Phone -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="name"
                            >Full Name <span class="required">*</span></label
                        >
                        <input
                            type="text"
                            id="name"
                            name="name"
                            placeholder="John Doe"
                            required
                            class="form-input"
                        />
                    </div>
                    <div class="form-group">
                        <label for="phone"
                            >Phone Number <span class="required">*</span></label
                        >
                        <input
                            type="tel"
                            id="phone"
                            name="phone"
                            placeholder="(555) 123-4567"
                            required
                            class="form-input"
                        />
                    </div>
                </div>

                <!-- Address & Email -->
                <div class="form-group">
                    <label for="address"
                        >Service Address <span class="required">*</span></label
                    >
                    <input
                        type="text"
                        id="address"
                        name="address"
                        placeholder="123 Main St, Anytown, ON"
                        required
                        class="form-input"
                    />
                </div>
                <div class="form-group">
                    <label for="email"
                        >Email Address <span class="required">*</span></label
                    >
                    <input
                        type="email"
                        id="email"
                        name="email"
                        placeholder="you@example.com"
                        required
                        class="form-input"
                    />
                </div>

                <!-- Photos -->
                <div class="form-group">
                    <label for="photos">Upload Photos (Optional)</label>
                    <input
                        type="file"
                        id="photos"
                        name="photos"
                        accept="image/*"
                        multiple
                        class="form-input"
                    />
                </div>

                <!-- Image Preview -->
                <div id="imagePreviewContainer" class="image-preview-container">
                    <div id="imagePreview" class="image-preview"></div>
                </div>

                <!-- Notes -->
                <div class="form-group">
                    <label for="notes">Additional Notes (Optional)</label>
                    <textarea
                        id="notes"
                        name="notes"
                        rows="3"
                        class="form-input"></textarea>
                </div>

                <!-- Submit -->
                <div class="form-group">
                    <button type="submit" class="submit-btn"
                        >Confirm Booking</button
                    >
                    <a class="cancel" href="/"> Cancel </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="message-box">
        <div class="message-content">
            <h3 id="messageTitle"></h3>
            <p id="messageContent"></p>
            <button
                onclick="document.getElementById('messageBox').classList.add('hidden')"
                >Close</button
            >
        </div>
    </div>
</Layout>
<script type="module">
    const maxFiles = 5;
    const maxFileSize = 5 * 1024 * 1024; // 5MB
    let selectedFilesArray = [];

    // Show message
    function showMessage(title, content) {
        const box = document.getElementById("messageBox");
        document.getElementById("messageTitle").textContent = title;
        document.getElementById("messageContent").innerHTML = content;
        box.style.display = "flex";
    }

    // Update Garage Size requirement
    function updateGarageSizeRequirement() {
        const service = document.getElementById("service").value;
        const garageSize = document.getElementById("garageSize");
        const label = document.getElementById("garageSizeLabel");

        const required =
            service === "NewDoorInstall" || service === "FloorCoating";
        garageSize.required = required;
        if (required)
            label.innerHTML = 'Garage Size <span class="required">*</span>';
        else label.textContent = "Garage Size (Optional for Repair)";
    }

    // Remove image
    window.removeImage = function (index) {
        selectedFilesArray.splice(index, 1);
        renderPreviews();
    };

    // Render previews
    function renderPreviews() {
        const container = document.getElementById("imagePreviewContainer");
        const preview = document.getElementById("imagePreview");

        preview.innerHTML = "";
        if (selectedFilesArray.length === 0) {
            container.style.display = "none";
            return;
        }
        container.style.display = "block";

        selectedFilesArray.forEach((file, i) => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const wrapper = document.createElement("div");
                wrapper.style.position = "relative";

                const img = document.createElement("img");
                img.src = e.target.result;
                img.alt = file.name;

                const btn = document.createElement("button");
                btn.textContent = "X";
                btn.className = "remove-btn";
                btn.onclick = () => window.removeImage(i);

                wrapper.appendChild(img);
                wrapper.appendChild(btn);
                preview.appendChild(wrapper);
            };
            reader.readAsDataURL(file);
        });
    }

    // Handle file selection
    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        selectedFilesArray = [];

        files.forEach((file) => {
            if (
                selectedFilesArray.length < maxFiles &&
                file.type.startsWith("image/") &&
                file.size <= maxFileSize
            ) {
                selectedFilesArray.push(file);
            }
        });

        renderPreviews();
    }

    // Form submission
    document
        .getElementById("bookingForm")
        .addEventListener("submit", function (e) {
            console.log("unde");

            e.preventDefault();

            const service = document.getElementById("service").value;
            if (!service)
                return showMessage("Error", "Please select a service.");

            const garage = document.getElementById("garageSize");
            if (garage.required && !garage.value)
                return showMessage("Error", "Garage size required.");

            const phone = document.getElementById("phone").value;
            if (!phone) return showMessage("Error", "Phone required.");

            const formData = {
                service: service,
                garageSize: garage.value,
                date: document.getElementById("date").value,
                time: document.getElementById("time").value,
                name: document.getElementById("name").value,
                phone: phone,
                email: document.getElementById("email").value,
                address: document.getElementById("address").value,
                notes: document.getElementById("notes").value,
                fileCount: selectedFilesArray.length,
            };

            let content = `Thank you, <strong>${formData.name}</strong>!<br>
    Appointment: <strong>${formData.service}</strong><br>
    Date: ${formData.date} at ${formData.time}<br>
    Address: ${formData.address}<br>
    Garage Size: ${formData.garageSize || "Not specified"}<br>
    ${formData.fileCount ? formData.fileCount + " photo(s) attached" : "No photos"}<br>
    We will call you at ${formData.phone}. Confirmation sent to ${formData.email}.`;

            showMessage("Booking Confirmed!", content);

            this.reset();
            selectedFilesArray = [];
            renderPreviews();
            updateGarageSizeRequirement();
        });

    // Initialize
    window.onload = function () {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        document.getElementById("date").min = `${yyyy}-${mm}-${dd}`;
        updateGarageSizeRequirement();
    };

    document
        .getElementById("service")
        .addEventListener("change", updateGarageSizeRequirement);
    document
        .getElementById("photos")
        .addEventListener("change", handleFileSelect);
</script>
