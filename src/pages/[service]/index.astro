---
import "../../styles/global.css";
import { Picture } from "astro:assets";
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import UtilityNav from "../../components/UtilityNav.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { getCityLogo, getDoorTypeImage } from "../../utils/helpers"; // Assuming a simple helper function
import {
    Settings,
    VolumeX,
    AlertTriangle,
    Wrench,
    Cable,
    type Icon as IconType,
} from "@lucide/astro";
import { ArrowRight } from "@lucide/astro";

// Define the type for clarity
type ServicePageEntry = CollectionEntry<"service-areas">;

// 1. getStaticPaths: Defines ALL the service index pages to be built
export async function getStaticPaths() {
    const serviceAreas = await getCollection("service-areas");
    const serviceCatalogs = await getCollection("service-catalogs");

    // Get a unique list of all services offered across all cities AND catalogs
    const uniqueServices = new Set([
        ...serviceAreas.map((page) => page.data.service),
        ...serviceCatalogs.map((entry) => entry.data.service),
    ]);

    // Map the unique services to create the index pages
    return Array.from(uniqueServices).map((service) => ({
        params: { service },
        props: { service },
    }));
}

// 2. Data Fetching
const { service } = Astro.props as { service: string };

// Fetch all pages related to this specific service (e.g., all 'repair' areas)
const relatedAreas = (await getCollection("service-areas")).filter(
    (page) => page.data.service === service,
);

// Fetch all product/repair catalog entries related to this service (e.g., all 'broken-springs')
const relatedCatalogs = (await getCollection("service-catalogs"))
    .filter((entry) => entry.data.service == service)
    .sort((a, b) => a.data.title.localeCompare(b.data.title));

// Get the friendly name (e.g., 'New Garage Door Installation') from the first related page
const serviceName =
    relatedAreas[0]?.data.serviceName || service.replace(/-/g, " ");

// Set SEO metadata
const title = `${serviceName} Service Areas | York Garage Pros`;
// const h1 = `Select Your City or Service for Expert ${serviceName} Service`;
const metaDescription = `Find certified ${serviceName} service in the York Region. We offer specialized repairs and installation across ${relatedAreas.map((p) => p.data.cityName).join(", ")}.`;

const h1 = `${serviceName} Service: Select Your Service or City`;

// Helper for display text
const catalogSectionTitle =
    service === "garage-door-repair"
        ? "Specialized Repair Services"
        : "Product Types & Brands";
const getIcon = (slug: string): typeof IconType => {
    if (slug.includes("springs")) return Settings; // Represents the mechanical tension system
    if (slug.includes("cables")) return Cable; // Directly represents the frayed/broken cable
    if (slug.includes("roller")) return VolumeX; // Represents silencing the noisy door
    // if (slug.includes('off-track')) return AlertTriangle; // Represents the high-urgency derailment
    return Wrench; // Default for general repairs
};
const relatedCatalogsWithIcons = relatedCatalogs.map((entry) => ({
    ...entry,
    iconName: getIcon(entry.data.type),
}));
---

<Layout title={title} description={metaDescription}>
    <UtilityNav />
    <Header />

    <section class="repair-hub-section">
        <h1 class="hub-title">
            {h1}
        </h1>

        <p class="hub-intro">
            Click on your immediate repair need or select your city for
            dedicated, local 24/7 service.
        </p>

        {
            relatedCatalogsWithIcons.length > 0 && (
                <div class="specialty-section">
                    <h2 class="section-heading">{catalogSectionTitle}</h2>
                    <div class="specialty-grid">
                        {relatedCatalogsWithIcons.map((entry) => (
                            <a
                                href={`/${service}/${entry.data.type}`}
                                class="specialty-card"
                            >
                                <Picture
                                    src={getDoorTypeImage(entry.data.type)}
                                    alt={`${entry.data.type.replace(/-/g, " ")}`}
                                    class="type-image"
                                    loading="lazy"
                                />
                                <div class="specialty-text">
                                    <h3 class="specialty-name">
                                        {entry.data.cardTitle ||
                                            entry.data.title}
                                    </h3>
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            )
        }

        {
            relatedAreas.length > 0 && (
                <div class="city-links-section">
                    <h2 class="section-heading">
                        Service Areas for {serviceName}
                    </h2>
                    <div class="city-grid">
                        {relatedAreas.map((page) => (
                            <a
                                href={`/${page.data.service}/${page.data.city}`}
                                class="city-card-new"
                            >
                                <div class="logo-name">
                                    <Picture
                                        src={getCityLogo(page.data.city)}
                                        alt={`${page.data.cityName} City Logo`}
                                        class="city-logo-new"
                                        loading="lazy"
                                    />
                                    <div class="city-text">
                                        <h3 class="city-name-new">
                                            {page.data.cityName}
                                        </h3>
                                        <p class="city-desc-new">
                                            View our expert{" "}
                                            {page.data.serviceName} options in{" "}
                                            {page.data.cityName}.
                                        </p>
                                    </div>
                                </div>
                                <ArrowRight class="city-arrow" />
                            </a>
                        ))}
                    </div>
                </div>
            )
        }
    </section>

    <div class="cta-block">
        <div class="cta-content">
            <h2>Need Immediate Assistance? Call Us Now!</h2>
            <p>
                Our technicians are on call 24/7 for all garage door emergencies
                in your area.
            </p>
            <a href="tel:+19059609947" class="cta-button">
                CALL NOW (905) 960-9947
            </a>
        </div>
    </div>

    <Footer />
</Layout>

<style>
    /* ========= Variables ========= */
    :root {
        --navy-dark: #1c2a44;
        --gold: #e8a900;
        --gold-light: #ffc433;
        --gray-700: #374151;
        --gray-600: #4b5563;
        --bg-light: #ffffff;
        --shadow-md: 0 4px 10px rgba(0, 0, 0, 0.05);
        --shadow-lg: 0 8px 18px rgba(0, 0, 0, 0.1);
    }

    /* ========= General Section Styling ========= */
    .repair-hub-section {
        max-width: 1100px;
        margin: 0 auto;
        padding: 64px 16px;
    }

    .hub-title {
        font-size: 2.5rem;
        font-family: "Montserrat-ExtraBold", "Inter", sans-serif;
        color: var(--navy-dark);
        text-align: center;
        margin-bottom: 16px;
    }

    .hub-intro {
        font-size: 1.125rem;
        color: var(--gray-700);
        text-align: center;
        margin-bottom: 48px;
    }

    .section-heading {
        font-size: 1.75rem;
        font-family: "Montserrat-Bold", "Inter", sans-serif;
        color: var(--navy-dark);
        text-align: center;
        margin-bottom: 28px;
        border-bottom: 2px solid var(--gold-light);
        display: inline-block;
        padding-bottom: 8px;
        margin-left: auto;
        margin-right: auto;
        display: block;
        width: fit-content;
    }

    /* 1. Repair Specialties (High-Conversion Focus) */
    .specialty-section {
        margin-bottom: 60px;
    }

    .specialty-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 20px;
    }

    .specialty-card {
        /* display: flex; */
        align-items: center;
        background: var(--bg-light);
        padding: 24px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: var(--shadow-md);
        text-decoration: none;
        transition:
            transform 0.25s ease,
            box-shadow 0.25s ease,
            border-color 0.25s ease;
    }

    .specialty-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--gold);
    }

    .specialty-icon {
        font-size: 2.5rem;
        margin-right: 20px;
        line-height: 1; /* Ensures icon is centered */
    }

    .specialty-name {
        font-size: 1.25rem;
        font-family: "Montserrat-Bold", "Inter", sans-serif;
        color: var(--navy-dark);
        margin-bottom: 4px;
    }

    .specialty-desc {
        font-size: 0.95rem;
        color: var(--gray-600);
        /* Ensures description doesn't exceed two lines */
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .type-image {
        width: 100%;
        max-width: fit-content;
        aspect-ratio: 1/1;
        height: auto;
    }
    /* 2. City Links (New Horizontal Card Design) */
    .city-links-section {
        margin-bottom: 60px;
    }

    .city-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Two columns on mobile */
        gap: 16px;
    }

    .city-card-new {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f9fafb; /* Light background for contrast */
        padding: 16px 20px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        text-decoration: none;
        transition:
            background 0.25s ease,
            border-color 0.25s ease;
    }

    .city-card-new:hover {
        background: var(--bg-light);
        border-color: var(--navy-dark);
    }

    .city-logo-new {
        max-width: 80px; /* Smaller, focused logo */
        height: 35px;
        object-fit: contain;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .city-text {
        flex-grow: 1;
        margin-right: 12px;
    }

    .city-name-new {
        font-size: 1rem;
        font-family: "Montserrat-Bold", "Inter", sans-serif;
        color: var(--navy-dark);
        margin: 0;
    }

    .city-desc-new {
        display: none; /* Hide description for cleaner card */
    }

    .city-arrow {
        font-size: 1.5rem;
        color: var(--gold);
        transition: transform 0.25s ease;
    }

    .city-card-new:hover .city-arrow {
        transform: translateX(4px);
    }

    /* 3. New Call-to-Action Block */
    .cta-block {
        background-color: var(--navy-dark);
        color: white;
        padding: 40px 16px;
        text-align: center;
        margin: 40px 0;
    }

    .cta-content h2 {
        font-size: 2rem;
        font-family: "Montserrat-ExtraBold", "Inter", sans-serif;
        margin-top: 0;
        margin-bottom: 10px;
        color: white;
    }

    .cta-content p {
        font-size: 1.15rem;
        margin-bottom: 20px;
        opacity: 0.85;
    }

    .cta-button {
        display: inline-block;
        background: var(--gold);
        color: var(--navy-dark);
        font-weight: 700;
        font-family: "Montserrat-Bold", "Inter", sans-serif;
        font-size: 1.2rem;
        padding: 12px 30px;
        border-radius: 8px;
        text-decoration: none;
        transition: background 0.2s ease;
        box-shadow: var(--shadow-md);
    }

    .cta-button:hover {
        background: var(--gold-light);
    }

    /* ========= Responsive Adjustments ========= */
    @media (min-width: 640px) {
        .hub-title {
            font-size: 2.8rem;
        }
        .specialty-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 900px) {
        .specialty-grid {
            grid-template-columns: repeat(
                4,
                1fr
            ); /* 4 columns on large screens */
        }
        .city-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
</style>
