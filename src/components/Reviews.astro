---
// src/components/Reviews.astro
const PLACE_ID = "CUzO9_99F8FREBM";
const API_KEY = import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY;

let reviews = [];
let rating = 0;
let totalReviews = 0;

console.log('I got here');
try {
    
  const response = await fetch(
    `https://maps.googleapis.com/maps/api/place/details/json?place_id=${PLACE_ID}&fields=reviews,rating,user_ratings_total&key=${API_KEY}`
  );
  const data = await response.json();
  console.log(data,response);
  
  
  if (data.result) {
    reviews = data.result.reviews || [];
    rating = data.result.rating;
    totalReviews = data.result.user_ratings_total;
  }
} catch (error) {
  console.error("Error fetching Google Reviews:", error);
}

// SEO Schema
const schema = {
  "@context": "https://schema.org/",
  "@type": "LocalBusiness",
  "name": "York Garage Pros",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": rating,
    "reviewCount": totalReviews,
    "bestRating": "5"
  }
};
---

<section class="reviews-section">
  <script type="application/ld+json" set:html={JSON.stringify(schema)} />

  <div class="reviews-header">
    <h2>Customer Feedback</h2>
    <div class="overall-rating">
      <span class="stars">{"★".repeat(Math.round(rating))}</span>
      <span class="count">{rating} ({totalReviews} Reviews)</span>
    </div>
  </div>

  <div class="reviews-grid">
    {reviews.length > 0 ? (
      reviews.map((rev) => (
        <div class="review-card">
          <div class="rev-meta">
            <img src={rev.profile_photo_url} alt={rev.author_name} loading="lazy" />
            <div>
              <p class="author">{rev.author_name}</p>
              <p class="date">{rev.relative_time_description}</p>
            </div>
          </div>
          <div class="stars">{"★".repeat(rev.rating)}</div>
          <p class="text">"{rev.text.substring(0, 200)}..."</p>
        </div>
      ))
    ) : (
      <p>Loading our latest 5-star success stories...</p>
    )}
  </div>

  <div class="cta-wrapper">
    <a href="https://g.page/r/YOUR_ID/review" target="_blank" class="btn-review">
      Leave us a Review on Google
    </a>
  </div>
</section>

<style>
  .reviews-section { padding: 4rem 1rem; max-width: 1000px; margin: 0 auto; }
  .reviews-header { text-align: center; margin-bottom: 3rem; }
  .stars { color: #fbbf24; font-size: 1.25rem; }
  
  /* Grid designed for small counts - scales nicely from 1 to 3 reviews */
  .reviews-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
    gap: 20px; 
  }
  
  .review-card {
    background: #f8fafc;
    padding: 24px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
  }
  .rev-meta { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
  .rev-meta img { width: 40px; height: 40px; border-radius: 50%; }
  .author { font-weight: 700; margin: 0; font-size: 0.95rem; }
  .date { font-size: 0.8rem; color: #64748b; margin: 0; }
  .text { font-style: italic; color: #334155; line-height: 1.6; }

  .cta-wrapper { text-align: center; margin-top: 3rem; }
  .btn-review {
    display: inline-block;
    padding: 12px 24px;
    background: #2563eb;
    color: white;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 700;
  }
</style>